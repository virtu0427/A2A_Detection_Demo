{% extends "base.html" %}
{% block title %}{{ agent.name }} · 에이전트 상세{% endblock %}
{% block page_id %}agent-detail{% endblock %}
{% block extra_head %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/vis-network/styles/vis-network.min.css"
  />
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js" defer></script>
{% endblock %}
{% block content %}
  <section class="panel hero-panel compact">
    <div class="hero-copy">
      <h1>{{ agent.name }}</h1>
      <p>{{ agent.purpose }}</p>
      <div class="hero-tags">
        <span>{{ agent.role }}</span>
        <span>{{ agent.model }}</span>
        <span>{{ agent.department }}</span>
      </div>
    </div>
    <div class="metric-capsule">
      <dl>
        <div>
          <dt>상태</dt>
          <dd><span class="status-indicator"><span class="status-dot status-{{ agent.status|lower }}"></span>{{ agent.status }}</span></dd>
        </div>
        <div>
          <dt>위험 점수</dt>
          <dd>{{ (agent.risk_score * 100)|round(1) }}%</dd>
        </div>
        <div>
          <dt>최근 활동</dt>
          <dd>{{ agent.last_seen.replace('T', ' ') }}</dd>
        </div>
        <div>
          <dt>위치</dt>
          <dd>{{ agent.location }}</dd>
        </div>
      </dl>
      <p class="metric-updated">IP {{ agent.ip_address }} · 담당자 {{ agent.user_name }}</p>
    </div>
  </section>

  <section class="panel">
    <header class="panel-header">
      <h2>기본 정보</h2>
      <p>에이전트 운영 조직 및 모델 버전을 확인하세요.</p>
    </header>
    <div class="agent-info-grid">
      <dl>
        <dt>부서</dt>
        <dd>{{ agent.department }}</dd>
      </dl>
      <dl>
        <dt>사용자</dt>
        <dd>{{ agent.user_name }}</dd>
      </dl>
      <dl>
        <dt>모델 버전</dt>
        <dd>{{ agent.model }}</dd>
      </dl>
      <dl>
        <dt>최근 탐지 로그</dt>
        <dd>{% if packets %}{{ packets[0].timestamp.replace('T', ' ') }}{% else %}-{% endif %}</dd>
      </dl>
    </div>
  </section>

  <section class="panel">
    <header class="panel-header">
      <div>
        <h2>연결된 에이전트 그래프</h2>
        <p>연결선을 클릭해 탐지된 위협 요약을 확인하세요.</p>
      </div>
      <div class="panel-actions">
        <button type="button" id="btn-reset-agent-graph">초기 보기</button>
      </div>
    </header>
    <div class="agent-graph-section">
      <div id="agent-detail-graph"></div>
    </div>
  </section>

  <div class="graph-layout" style="height: auto; grid-template-columns: 1fr 1fr;">
    <section class="panel">
      <header class="panel-header">
        <h3>최근 위협 통신</h3>
      </header>
      <ul class="communication-list">
        {% for comm in communications %}
          <li>
            <div class="comm-header">
              <strong>{{ comm.source }}</strong>
              <span class="icon-arrow">→</span>
              <strong>{{ comm.target }}</strong>
            </div>
            <p class="meta">{{ comm.last_activity.replace('T', ' ') }}</p>
            <p>{{ comm.summary }}</p>
          </li>
        {% else %}
          <li class="empty-state">연결된 위협 통신이 없습니다.</li>
        {% endfor %}
      </ul>
    </section>
    <section class="panel">
      <header class="panel-header">
        <h3>관련 패킷 로그</h3>
      </header>
      <ul class="communication-list">
        {% for packet in packets %}
          <li>
            <a href="{{ url_for('packet_detail', packet_id=packet.id) }}">
              <div class="comm-header">
                <strong>{{ packet.threat_type }}</strong>
                <span class="badge {{ 'high' if packet.severity == '높음' else 'medium' if packet.severity == '중간' else 'low' }}">{{ packet.severity }}</span>
              </div>
              <p class="meta">{{ packet.timestamp.replace('T', ' ') }} · {{ packet.protocol_layer }}</p>
              <p class="meta">{{ packet.source_agent }} → {{ packet.target_agent }}</p>
              <p>{{ packet.description }}</p>
            </a>
          </li>
        {% else %}
          <li class="empty-state">관련 패킷 로그가 없습니다.</li>
        {% endfor %}
      </ul>
    </section>
  </div>
{% endblock %}

{% block extra_body %}
  {{ super() }}
  <script>
    window.agentDetailData = {
      agentId: {{ agent.id }},
      name: {{ agent.name|tojson }},
      communications: {{ communications|tojson }},
      relatedAgents: {{ related_agents|tojson }},
    };
  </script>
{% endblock %}
